---
title: èŠèŠä¾èµ–æ³¨å…¥
customTag: tech>å·¥ç¨‹è®¾è®¡
editLink: true
date: 2024.05.19
---

# èŠèŠä¾èµ–æ³¨å…¥
<aside> ğŸ’¡ ä¾èµ–æ³¨å…¥æ˜¯ä¾èµ–åè½¬çš„ä¸€ç§å…·ä½“å®ç°ã€‚

</aside>

## ä¾èµ–æ³¨å…¥æ˜¯å•¥

ä¾èµ–æ³¨å…¥ï¼ˆDependency Injectionï¼ŒDIï¼‰æ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œç”¨äºç®¡ç†æ¨¡å—ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚ä¾èµ–å…³ç³»çš„åˆ›å»ºå’Œç»´æŠ¤ä¸ç”±æ¨¡å—è‡ªèº«è´Ÿè´£ï¼Œè€Œæ˜¯ç”±å¤–éƒ¨çš„å®¹å™¨ï¼ˆé€šå¸¸æ˜¯ä¸€ä¸ªä¾èµ–æ³¨å…¥å®¹å™¨ï¼‰æ¥å®Œæˆã€‚ç®€å•æ¥è¯´ï¼Œä¾èµ–æ³¨å…¥å°±æ˜¯å°†ä¾èµ–å¯¹è±¡ä¼ é€’ç»™éœ€è¦å®ƒçš„å¯¹è±¡ï¼Œè€Œä¸æ˜¯ç”±è¢«ä¾èµ–å¯¹è±¡è‡ªå·±å»åˆ›å»ºæˆ–è€…æŸ¥æ‰¾ä¾èµ–çš„å¯¹è±¡ã€‚

## **ä¸ºä»€ä¹ˆéœ€è¦ä¾èµ–æ³¨å…¥ï¼Ÿ**

**æ ¸å¿ƒæ€æƒ³åœ¨äºè§£è€¦ï¼Œå°†ä¾èµ–å…³ç³»ä»æ¨¡å—ä¹‹é—´è½¬ç§»åˆ°å¤–éƒ¨çš„å®¹å™¨æ¥å®Œæˆï¼Œä»è€Œé™ä½äº†æ¨¡å—ä¹‹é—´çš„è€¦åˆåº¦ï¼Œä½¿å¾—ç³»ç»Ÿæ›´åŠ çµæ´»ã€å¯æ‰©å±•å’Œæ˜“äºæµ‹è¯•ã€‚**

**ä¼˜ç‚¹åœ¨äº**ï¼š

1. **è§£è€¦åˆï¼š** ä¾èµ–æ³¨å…¥å°†ä¾èµ–å…³ç³»çš„åˆ›å»ºå’Œç»´æŠ¤ä»è¢«ä¾èµ–å¯¹è±¡ä¸­è§£è€¦å‡ºæ¥ï¼Œä½¿å¾—æ¨¡å—ä¹‹é—´çš„è€¦åˆåº¦é™ä½ï¼Œæé«˜äº†ç³»ç»Ÿçš„çµæ´»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚
2. **å¯æµ‹è¯•æ€§ï¼š** ä¾èµ–æ³¨å…¥ä½¿å¾—ä¾èµ–å…³ç³»å¯ä»¥é€šè¿‡å¤–éƒ¨å‚æ•°ä¼ å…¥ï¼Œè¿™æ ·åœ¨å•å…ƒæµ‹è¯•ä¸­å¯ä»¥æ›´è½»æ¾åœ°æ¨¡æ‹Ÿä¾èµ–å¯¹è±¡ï¼Œä»è€Œè¿›è¡Œæ›´åŠ ç²¾ç¡®å’Œæœ‰æ•ˆçš„å•å…ƒæµ‹è¯•ã€‚
3. **å¯é‡ç”¨æ€§ï¼š** é€šè¿‡ä¾èµ–æ³¨å…¥ï¼Œå¯ä»¥å°†ä¾èµ–å¯¹è±¡ä¸å…·ä½“å®ç°è§£è€¦ï¼Œä½¿å¾—ä¾èµ–å¯¹è±¡å¯ä»¥åœ¨ä¸åŒçš„ä¸Šä¸‹æ–‡ä¸­è¢«é‡ç”¨ï¼Œæé«˜äº†ä»£ç çš„å¯é‡ç”¨æ€§ã€‚
4. **å¯æ›¿ä»£æ€§ï¼š** ä¾èµ–æ³¨å…¥ä½¿å¾—ä¾èµ–å…³ç³»å˜å¾—æ›´åŠ çµæ´»ï¼Œå¯ä»¥è½»æ¾åœ°æ›¿æ¢æ‰è¢«ä¾èµ–å¯¹è±¡çš„å…·ä½“å®ç°ï¼Œè€Œä¸ä¼šå½±å“åˆ°ä¾èµ–å¯¹è±¡çš„è°ƒç”¨æ–¹ã€‚

å…·ä½“ä¸¾ä¸ªä¾‹å­, æ¯”å¦‚ä½ æœ‰ä¸€ä¸ªé€šçŸ¥çš„ NoticeService çš„æœåŠ¡ã€‚

ä¸€å¼€å§‹ï¼Œä½ çš„ä»£ç å¦‚ä¸‹ã€‚ä¸€å¼€å§‹ä½¿ç”¨é‚®ä»¶æ¥ç»™ç”¨æˆ·å‘é€ä¿¡æ¯ã€‚

```jsx
class App {
  constructor() {
    this.emailService = new EmailService(); // ç›´æ¥ä¾èµ–å…·ä½“çš„å®ç°ç±»
  }
  
  notice(message: string) {
    return this.emailService.send(message);
  }
}
```

ä¸Šæ–¹è¿™ä¸ªä»£ç ç¡®å®æ²¡å•¥é—®é¢˜ï¼Œä½†åˆ°äº†æŸä¸€å¤©ï¼Œäº§å“å¤§å¤§è¯´ï¼Œæˆ‘ä»¬éœ€è¦ç»™å‘é€ sns çš„çŸ­ä¿¡ä¿¡æ¯ã€‚äºæ˜¯ä¹ï¼Œä½ åšäº†ä»£ç ä¿®æ”¹ã€‚

```diff
class App {
  constructor() {
-   this.emailService = new EmailService(); // ç›´æ¥ä¾èµ–å…·ä½“çš„å®ç°ç±»
+   this.snsService = new SnsService(); // ç›´æ¥ä¾èµ–å…·ä½“çš„å®ç°ç±»
  }
  
  notice(message: string) {
-    return this.emailService.send(message);
+    return this.snsService.send(message);
  }
}
```

ä½†ä¹Ÿè®¸åç»­è¿˜æœ‰å…¶ä»–çš„å˜æ›´å‘¢ï¼Œæ¯”å¦‚ APPï¼ŒWeb, WeChat ç­‰å…¶ä»–é€šçŸ¥å‘¢ã€‚è¿™ä¸ªæ—¶å€™å¯ä»¥å°±é‡‡ç”¨ä¾èµ–æ³¨å…¥äº†ã€‚

```jsx
class App {
  constructor(noticeService: NoticeService) {
    this.noticeService = noticeService; // ç›´æ¥ä¾èµ–å…·ä½“çš„å®ç°ç±»
  }
  
  notice(message: string) {
    return this.noticeService.send(message);
  }
}

const emailNoticeService = new EmailNoticeService();
const app = new App(emailNoticeService);

app.notice('æµ‹è¯•');
```

å…¶å®ä¸Šæ–¹çš„ä»£ç ï¼Œæˆ‘ä»¬å·²ç»å®ç°äº†**ä¾èµ–æ³¨å…¥**çš„æ•ˆæœã€‚

## ä»€ä¹ˆæ˜¯ä¾èµ–æ³¨å…¥å®¹å™¨

è°ˆåŠä¾èµ–æ³¨å…¥çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šå¬åˆ°â€œä¾èµ–æ³¨å…¥å®¹å™¨â€çš„æ¦‚å¿µã€‚

**ä¾èµ–æ³¨å…¥å®¹å™¨æ˜¯ä¸€ä¸ªæ¡†æ¶æˆ–å·¥å…·ï¼Œç”¨äºç®¡ç†åº”ç”¨ç¨‹åºä¸­çš„å¯¹è±¡ä¾èµ–å…³ç³»ã€‚**å®ƒè´Ÿè´£åˆ›å»ºå¯¹è±¡å¹¶è§£æå®ƒä»¬ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œå¹¶åœ¨éœ€è¦æ—¶å°†ä¾èµ–é¡¹æ³¨å…¥åˆ°å¯¹è±¡ä¸­ã€‚

ä»¥ä¸‹æ˜¯ä¸ºä»€ä¹ˆéœ€è¦ä¾èµ–æ³¨å…¥å®¹å™¨çš„ä¸€äº›ä¸»è¦åŸå› ï¼š

1. **é™ä½è€¦åˆåº¦ï¼š** ä¾èµ–æ³¨å…¥å®¹å™¨å¯ä»¥å¸®åŠ©å°†å¯¹è±¡çš„åˆ›å»ºå’Œä¾èµ–é¡¹çš„æ³¨å…¥è§£è€¦ã€‚å¯¹è±¡ä¸å†éœ€è¦ç›´æ¥åˆ›å»ºæˆ–è·å–å®ƒæ‰€ä¾èµ–çš„å¯¹è±¡ï¼Œè€Œæ˜¯ç”±å®¹å™¨è´Ÿè´£ç®¡ç†ï¼Œä»è€Œé™ä½äº†å¯¹è±¡ä¹‹é—´çš„è€¦åˆåº¦ã€‚
2. **ç®€åŒ–é…ç½®ï¼š** ä¾èµ–æ³¨å…¥å®¹å™¨é€šå¸¸æä¾›é…ç½®æœºåˆ¶ï¼Œå…è®¸å¼€å‘äººå‘˜é€šè¿‡é…ç½®æ–‡ä»¶æˆ–æ³¨è§£æ¥é…ç½®å¯¹è±¡åŠå…¶ä¾èµ–é¡¹çš„åˆ›å»ºæ–¹å¼å’Œå‚æ•°ã€‚è¿™ç§æ–¹å¼ç›¸æ¯”æ‰‹åŠ¨ç¼–ç å¯ä»¥æ›´ç®€æ´å’Œçµæ´»ã€‚
3. **æé«˜å¯æµ‹è¯•æ€§ï¼š** é€šè¿‡ä¾èµ–æ³¨å…¥å®¹å™¨ï¼Œå¯ä»¥æ›´è½»æ¾åœ°å°†æ¨¡æ‹Ÿå¯¹è±¡ï¼ˆMock objectsï¼‰æ³¨å…¥åˆ°è¢«æµ‹è¯•å¯¹è±¡ä¸­ï¼Œä»è€Œå®ç°å•å…ƒæµ‹è¯•ã€‚è¿™æ ·å¯ä»¥æ›´å®¹æ˜“åœ°æµ‹è¯•å¯¹è±¡çš„è¡Œä¸ºè€Œä¸ç”¨æ‹…å¿ƒä¾èµ–é¡¹çš„åˆ›å»ºå’Œç®¡ç†ã€‚
4. **ä¿ƒè¿›ä»£ç é‡ç”¨å’Œç»„ä»¶åŒ–ï¼š** ä¾èµ–æ³¨å…¥å®¹å™¨å¯ä»¥å¸®åŠ©å°†å¯¹è±¡åˆ†è§£ä¸ºæ›´å°çš„ç»„ä»¶ï¼Œå¹¶ä½¿è¿™äº›ç»„ä»¶æ›´å®¹æ˜“è¢«é‡ç”¨ã€‚é€šè¿‡å°†å¯¹è±¡çš„ä¾èµ–å…³ç³»å§”æ‰˜ç»™å®¹å™¨ç®¡ç†ï¼Œå¯ä»¥æ›´è½»æ¾åœ°å°†è¿™äº›ç»„ä»¶ç»„åˆåœ¨ä¸€èµ·æ„å»ºæ›´å¤æ‚çš„ç³»ç»Ÿã€‚
5. **æé«˜å¯ç»´æŠ¤æ€§ï¼š** ä¾èµ–æ³¨å…¥å®¹å™¨å¯ä»¥å¸®åŠ©æé«˜ä»£ç çš„å¯ç»´æŠ¤æ€§ï¼Œå› ä¸ºå®ƒå¯ä»¥ä½¿ä»£ç æ›´åŠ æ¸…æ™°å’Œæ˜“äºç†è§£ã€‚é€šè¿‡å°†å¯¹è±¡çš„åˆ›å»ºå’Œä¾èµ–é¡¹çš„æ³¨å…¥äº¤ç»™å®¹å™¨å¤„ç†ï¼Œå¯ä»¥å‡å°‘é‡å¤çš„ä»£ç ï¼Œå¹¶å°†å…³æ³¨ç‚¹åˆ†ç¦»ï¼Œä½¿å¾—ä»£ç æ›´æ˜“äºç»´æŠ¤å’Œç†è§£ã€‚

å…·ä½“ä¾‹å­

```tsx
interface Dependency<T = any> {
  new (...args: any[]): T;
}

export class Container {
  private dependencies: Map<string, Dependency> = new Map();

  register<T>(key: string, dependency: Dependency<T>): void {
    this.dependencies.set(key, dependency);
  }

  resolve<T>(key: string): T {
    // çœç•¥ code
  }
}

// ç¤ºä¾‹ä½¿ç”¨
class NoticeService {
  notice(msg: string) {
    console.log(`notice, ${msg}`);
  }
}

class App {
  constructor(private noticeService: NoticeService) {}

  notice(msg: string) {
    return this.noticeService.notice(msg);
  }
}

// åˆ›å»ºå®¹å™¨
const container = new Container();

// æ³¨å†Œä¾èµ–é¡¹
container.register("noticeService", NoticeService);
container.register("App", AppService);

// è§£æä¾èµ–é¡¹
const appService = container.resolve<App>("App");
appService.notice("hello");
```

é€šè¿‡ä¸Šæ–¹ï¼Œå…¶å®æˆ‘ä»¬èƒ½çœ‹åˆ°ï¼Œå®¹å™¨æœ¬è´¨ä¸Šé€šè¿‡ä¾èµ–æ³¨å…¥ï¼Œä¾èµ–è§£æçš„èƒ½åŠ›ï¼Œå»ç®¡ç†å¥½åº”ç”¨ä¸­çš„ä¾èµ–ã€‚

## ä¾èµ–æ³¨å…¥å®¹å™¨çš„æ€è·¯

â€œçŸ¥å…¶ç„¶ï¼ŒçŸ¥å…¶æ‰€ä»¥ç„¶â€ï¼Œä¾èµ–æ³¨å…¥å®¹å™¨èƒŒåçš„åŸç†ä¹Ÿæ˜¯å€¼å¾—æˆ‘ä»¬å»äº†è§£çš„ï¼Œè¿™æ ·å­æˆ‘ä»¬èƒ½æ›´å¥½çš„äº†è§£ä¾èµ–æ³¨å…¥å·¥å…·çš„ä½¿ç”¨ã€‚å…·ä½“å¦‚

1. nest ä¸­ä¸ºä»€ä¹ˆ @Injectable å°±èƒ½å¤Ÿæ³¨å…¥ä¾èµ–ã€‚
2. ä¾èµ–æ³¨å…¥ä¸­ä¾èµ–ä¸ºä»€ä¹ˆæ˜¯å•ä¸€å®ä¾‹ã€‚

äºæ˜¯ï¼Œä¸‹æ–¹æˆ‘ä»¬éœ€è¦å®ç°ä¸‹æ–¹å‡ ç‚¹

- **ä¾èµ–æ³¨å†Œ**ï¼šå£°æ˜é‚£äº›ä¾èµ–æ˜¯å¯ä»¥æ³¨å†Œåˆ°å®¹å™¨ä¸­ï¼Œä¾¿äºåç»­å®¹å™¨ç®¡ç†ã€‚
- **ä¾èµ–åˆ†æ**ï¼šåˆ›å»ºå¯¹è±¡ï¼Œæ‰¾åˆ°å¹¶åˆ›å»ºå¯¹åº”éœ€è¦çš„ä¾èµ–å¯¹è±¡ã€‚
- **åˆ›å»ºå®ä¾‹**ï¼šåˆ©ç”¨åˆ›å»ºå™¨å°†å®ä¾‹åˆ›å»ºå‡ºæ¥ï¼Œæ”¯æŒå•ä¾‹æ¨¡å¼ï¼Œå¤šä¾‹æ¨¡å¼ã€‚

æœ€ç»ˆï¼Œæˆ‘ä»¬å®ç°çš„ä»£ç ï¼Œå¦‚ä¸‹

```tsx
@Injectable()
class Noticer {
  notice(msg: string) {
    console.log(`app notice: ${msg}`);
  }
}

@Injectable()
class App {
  constructor(
    private noticer: Noticer,
  ) {}

  notice(msg: string) {
    this.noticer.notice(msg);
  }
}

const container = new Container();
const app = container.resolve(App);
app.notice('æµ‹è¯•ä¸€ä¸‹');
```

### ä¾èµ–æ³¨å†Œ

> ä¸€å¥è¯ï¼šé€šè¿‡ `@Injectable` çš„è£…é¥°å™¨å†™æ³•è¿›è¡Œå®¹å™¨ä¾èµ–çš„æ³¨å†Œã€‚

æˆ‘ä»¬å…ˆæ¥åˆ†æçœ‹çœ‹ä¾èµ–æ³¨å†Œçš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Œä»¥åŠå…·ä½“çš„ä½¿ç”¨å½¢å¼ã€‚

- æœ¬è´¨ï¼šæœ¬è´¨å°±æ˜¯ Container æœ‰ä¸€å¼ è¡¨ï¼Œå¯ä»¥å­˜å‚¨ä¾èµ–ï¼Œä»¥åŠåç»­è§£æä¾èµ–ä¾¿äºä¾èµ–çš„æŸ¥è¯¢ã€‚
- å½¢å¼ï¼šé€šè¿‡è£…é¥°å™¨æ¥è¿›è¡Œæ³¨å†Œä¾èµ–ã€‚

**è‡ªèº«èƒ½åŠ›æ³¨å†Œ**

è¿™é‡Œæ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨ ä¸€ä¸ª Map æ¥è¿›è¡Œå­˜å‚¨å°±è¡Œã€‚

```tsx
import "reflect-metadata";

interface Dependency<T = any> {
  new (...args: any[]): T;
}

export class Container {
  private dependencies: Map<string, Dependency> = new Map();

  register<T>(key: string, dependency: Dependency<T>): void {
    this.dependencies.set(key, dependency);
  }
}

const container = new Container();

export default container;
```

**è£…é¥°å™¨ä¾èµ–æ³¨å…¥**

æœ¬è´¨ä¸Šæ˜¯å°†ä¾èµ–å’Œå®¹å™¨äº§ç”Ÿå…³è”ï¼Œæ–¹ä¾¿åç»­å®¹å™¨æ¥åšä¾èµ–ç®¡ç†ã€‚

```tsx
import container from "./container";

export function Injectable<T>() {
  return (target: new (...args: any[]) => T) => {
    container.register(target.name, target);
  };
}
```

æˆ‘ä»¬å†™ä¸€æ®µä»£ç æ¥æµ‹è¯•æ•ˆæœã€‚

```tsx
import container from "./container";
import { Injectable } from "./injectable";

@Injectable()
class NoticeService {
  notice(msg: string) {
    console.log(`notice, ${msg}`);
  }
}

@Injectable()
class App {
  constructor(private noticeService: NoticeService) {}

  notice(msg: string) {
    return this.noticeService.notice(msg);
  }
}

```

ç»è¿‡ä»£ç è°ƒè¯•ï¼Œç¡®å®çœ‹åˆ°ä¾èµ–è¢«è‡ªåŠ¨æ³¨å…¥åˆ° `Container` çš„ `Dependencies` ä¸­ã€‚

![image.png](https://raw.githubusercontent.com/hua-bang/assert-store/master/20240519185249.png)

ç›®å‰ï¼Œæˆ‘ä»¬æœ€åŸºç¡€çš„é€šç”¨è£…é¥°å™¨è¿›è¡Œä¾èµ–æ³¨å…¥å·²ç»å®Œæˆäº†ã€‚

### ä¾èµ–è§£æ

> è·å–æ¨¡å—çš„ä¾èµ–å…³ç³»ï¼Œå¹¶åœ¨è¯¥æ¨¡å—åˆå§‹åŒ–ä¹‹å‰ï¼Œæä¾›å¥½è¿™äº›ä¾èµ–å¯¹è±¡ã€‚

ä½†è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¦‚ä½•è·å–åˆ°å¯¹åº”çš„ä¾èµ–æ¨¡å—å‘¢ã€‚

è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬ç»“åˆæˆ‘ä»¬çš„ä¾‹å­çœ‹ä¸€çœ‹ã€‚

```tsx
import container from "./container";
import { Injectable } from "./injectable";

@Injectable()
class NoticeService {
  notice(msg: string) {
    console.log(`notice, ${msg}`);
  }
}

@Injectable()
class App {
  constructor(private noticeService: NoticeService) {}

  notice(msg: string) {
    return this.noticeService.notice(msg);
  }
}

```

çœ‹äº†ä¸‹ä»£ç ï¼Œåªè¦æˆ‘ä»¬å°†æ¨¡å—ä¸­

```tsx
import "reflect-metadata";

interface Dependency<T = any> {
  new (...args: any[]): T;
}

export class Container {
  private dependencies: Map<string, Dependency> = new Map();

  register<T>(key: string, dependency: Dependency<T>): void {
    this.dependencies.set(key, dependency);
  }

  resolve<T>(token: string): T {
    const target = this.dependencies.get(token);
    if (!target) {
      throw new Error(`Service not found: ${token}`);
    }

    // è·å–ç›®æ ‡ç±»çš„ä¾èµ–åˆ—è¡¨
    const dependencies = Reflect.getMetadata("design:paramtypes", target) || [];
    const injections = dependencies.map((dep: any) => {
      // å‡è®¾ä¾èµ–æ˜¯ç”¨å®ƒä»¬çš„ç±»åæ³¨å†Œçš„
      return this.resolve(dep.name);
    });

    return new target(...injections);
  }
}

const container = new Container();

export default container;
```

è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬æ¥è¿è¡Œå…·ä½“çš„ä¾‹å­ã€‚

```tsx
import container from "./container";
import { Injectable } from "./injectable";

@Injectable()
class NoticeService {
  notice(msg: string) {
    console.log(`notice, ${msg}`);
  }
}

@Injectable()
class App {
  constructor(private noticeService: NoticeService) {}

  notice(msg: string) {
    return this.noticeService.notice(msg);
  }
}

const appService = container.resolve<App>("App");
appService.notice("hello");
```

èƒ½çœ‹åˆ°ï¼Œå®é™…ä¸Šå·²ç»èƒ½è·‘åŠ¨äº†ã€‚æˆ‘ä»¬ä¹Ÿå®ç°äº†åŸºæœ¬çš„ mvp ç‰ˆæœ¬ã€‚

![image.png](https://raw.githubusercontent.com/hua-bang/assert-store/master/20240519185316.png)

### åˆ›å»ºå®ä¾‹

ç»†å¿ƒçš„æœ‹å‹ï¼Œå¯èƒ½ä¼šå‘ç°ä¸Šæ–¹å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä¸Šæ–¹ä¼šå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å¤šæ¬¡ `resolve` åŒä¸€ä¸ªä¾èµ–çš„æ—¶å€™ï¼Œä¼šåˆ›å»ºå¤šä¸ªå®ä¾‹ã€‚

ä¸¾ä¸ªä¾‹å­

```tsx
const appService = container.resolve<App>("App");
const appService2 = container.resolve<App>("App");
console.log("appService === appService2", appService === appService2);
```

æˆ‘ä»¬å¾—åˆ°çš„ç»“æœï¼Œç¡®å®ä¹ŸéªŒè¯äº†ï¼Œ `resolve` è¿‡ç¨‹ä¸­ï¼Œç”Ÿæˆäº†ä¸€ä¸ªæ–°çš„å¯¹è±¡ã€‚

![image.png](https://raw.githubusercontent.com/hua-bang/assert-store/master/20240519185331.png)


ä½†å®é™…æƒ…å†µä¸­ï¼Œæˆ‘ä»¬é€šå¸¸å¸Œæœ›ä¾èµ–çš„æ¨¡å—æ˜¯å•ä¾‹çš„ï¼Œä¸åŒæ¨¡å—ä¾èµ–çš„åŒä¸€ä¸ªæ¨¡å—å¸Œæœ›ä¿è¯æ˜¯ä¸€ä¸ªå®ä¾‹ã€‚

è¿™ä¸ªä¹Ÿæ¯”è¾ƒå¥½å¤„ç†ï¼Œæˆ‘ä»¬åœ¨å®¹å™¨ä¸­ç”¨ä¸€ä¸ª `Map` æ¥å­˜æ”¾å¥½å®ä¾‹å°±å¥½ã€‚

```diff
import "reflect-metadata";

interface Dependency<T = any> {
  new (...args: any[]): T;
}

export class Container {
  private dependencies: Map<string, Dependency> = new Map();
+  private instances: Map<string, any> = new Map();

  register<T>(key: string, dependency: Dependency<T>): void {
    this.dependencies.set(key, dependency);
  }

  resolve<T>(token: string): T {
    if (this.instances.has(token)) {
      return this.instances.get(token);
    }
    const target = this.dependencies.get(token);
    if (!target) {
      throw new Error(`Service not found: ${token}`);
    }

    // è·å–ç›®æ ‡ç±»çš„ä¾èµ–åˆ—è¡¨
    const dependencies = Reflect.getMetadata("design:paramtypes", target) || [];
    const injections = dependencies.map((dep: any) => {
      // å‡è®¾ä¾èµ–æ˜¯ç”¨å®ƒä»¬çš„ç±»åæ³¨å†Œçš„
      return this.resolve(dep.name);
    });

+    const instance = new target(...injections);

+    this.instances.set(token, instance);

-    return new target(...injections);
+    return instance;
  }
}

const container = new Container();

export default container;
```

è¿™ä¸ªæ—¶å€™çœ‹çœ‹æ•ˆæœï¼Œå¯ä»¥çœ‹åˆ°ä¹Ÿä¿è¯äº†å•ä¸ªå®ä¾‹ã€‚

![image.png](https://raw.githubusercontent.com/hua-bang/assert-store/master/20240519185342.png)

è‡³æ­¤ï¼Œä¸€ä¸ªæ¯”è¾ƒç®€å•çš„ä¾èµ–æ³¨å…¥å®¹å™¨çš„ `MVP` ç‰ˆæœ¬å°±å¤„ç†å¥½äº†ã€‚

## æ€»ç»“

æœ€åï¼Œæˆ‘ä»¬å›é¡¾ä¸€ä¸‹æœ¬æ–‡æˆ‘ä»¬çš„å†…å®¹ï¼Œæ— éæ˜¯ä»¥ä¸‹å‡ ç‚¹

- ä¾èµ–æ³¨å…¥çš„æ¦‚å¿µä»¥åŠä½œç”¨
- ä¾èµ–æ³¨å…¥å®¹å™¨çš„æ¦‚å¿µ
- é€šè¿‡ä¾èµ–æ³¨å†Œï¼Œä¾èµ–è§£æç­‰å®ç°äº†æœ€å°ä¾‹å­çš„ä¾èµ–æ³¨å…¥å®¹å™¨

å¸Œæœ›æ ¹æ®è¿™äº›å†…å®¹ï¼Œèƒ½å¤Ÿå¤§æ¦‚çš„äº†è§£ï¼Œä¾èµ–æ³¨å…¥å®¹å™¨çš„ä¸€ç‚¹ç‚¹çŸ¥è¯†ç‚¹ã€‚

å½“ç„¶ï¼Œè¿™é‡Œè¿˜æœ‰ä¸€äº›æ·±å…¥è¿›é˜¶çš„åŠŸèƒ½å¯ä»¥å®ç°ï¼Œæ¯”å¦‚å¾ªç¯ä¾èµ–å¤„ç†ã€ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆå•ä¾‹ã€å¤šä¾‹ï¼‰ã€å»¶è¿ŸåŠ è½½çš„ç‚¹ï¼Œå†è¿›ä¸€æ­¥å®ç°ã€‚

æœ¬æ–‡ä¹Ÿæ˜¯ä¸€ä¸ªæŠ›ç –å¼•ç‰çš„ä½œç”¨ï¼Œè¯»è€…ä¹Ÿå¯ä»¥è‡ªå·±æ¢ç´¢æ¢ç´¢ã€‚æ¯•ç«Ÿï¼Œ**ç†è§£ä¸€ä¸ªäº‹ç‰©çš„ä¸€ä¸ªåŠæ³•æ˜¯å®ç°å®ƒ**ã€‚