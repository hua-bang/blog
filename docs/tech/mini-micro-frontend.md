---
title: æ‰‹å†™ç±» Garfish å¾®å‰ç«¯æ¡†æ¶
customTag: tech>Frontend Engineer
editLink: true
date: 2024.09.01
---

# æ‰‹å†™ç±» Garfish å¾®å‰ç«¯æ¡†æ¶

## å‰è¨€

ä¸Šæ–‡æˆ‘ä»¬ç®€å•åœ°ä»‹ç»äº†å¾®å‰ç«¯çš„æ¦‚å¿µï¼Œæœ¬æ–‡æˆ‘ä»¬å°†å€Ÿé‰´ Garfish æ¥å®ç°æˆ‘ä»¬çš„ä¸€ä¸ªå¾®å‰ç«¯æ¡†æ¶ã€‚

åœ¨å®ç°ä¹‹å‰ï¼Œè¿˜æ˜¯å…ˆè®²è®² Garfish å§ï¼Œæ¯•ç«Ÿå®ç°ä¸€ä¸ªä¸œè¥¿ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆè¦äº†è§£ä»–ã€‚

## Garfish

<aside> ğŸ’¡ Garfish çš„è®¾è®¡æ€è·¯å’ŒæŠ€æœ¯ç»†èŠ‚åœ¨ [https://www.garfishjs.org/blog](https://www.garfishjs.org/blog) ä¸­ã€‚

</aside>

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ Garfish å¦‚ä½•ä½¿ç”¨ã€‚

æ ¹æ®å®˜æ–¹æ–‡æ¡£ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ä¸»åº”ç”¨ä¸­å†™ä¸‹æ–¹çš„ä»£ç ï¼Œæˆ‘ä»¬å°±æ‹¥æœ‰äº†æ‰§è¡Œ Garfish çš„èƒ½åŠ›ã€‚

![image.png](https://raw.githubusercontent.com/hua-bang/assert-store/master/20240901160543.png)

ä½†è¿™æ®µè¯­å¥èƒŒååšäº†å•¥å‘¢ï¼Œå®˜æ–¹çš„åšå®¢ï¼Œä¹Ÿç»™äº†å¯¹åº”çš„è¿è¡Œæµç¨‹å›¾ï¼Œæˆ‘ä»¬å¤§æ¦‚çœ‹è¿™ä¸ªå›¾ï¼Œä¹Ÿæ˜¯èƒ½ç¨å¾®ç†è§£ã€‚

ä½†ä¸€å¥è¯å°±æ˜¯ï¼šä¸»åº”ç”¨åšå¥½å­åº”ç”¨çš„æ³¨å†Œå¹¶è°ƒç”¨ [Garfish.run](http://Garfish.run)ï¼Œä¼šç›‘å¬è·¯ç”±å˜åŒ–ï¼Œä½†è·¯ç”±å˜åŒ–èƒ½åŒ¹é…æ–°çš„å­åº”ç”¨åï¼ŒGarfish ä¼šå¸è½½æ—§å­åº”ç”¨ï¼Œç„¶ååŠ è½½æ–°çš„å­åº”ç”¨ã€‚

![image.png](https://raw.githubusercontent.com/hua-bang/assert-store/master/20240901160606.png)


è€Œå¦‚ä½•å®ç°è¿™ä¸ªæµç¨‹ï¼Œä¸»è¦è¿˜æ˜¯å½’åŠŸäºä¸‹æ–¹ Garfish çš„è®¾è®¡ã€‚
![image.png](https://raw.githubusercontent.com/hua-bang/assert-store/master/20240901160624.png)

- **ä¸»åº”ç”¨åŸºåº§**ï¼šæŒ‡æˆ‘ä»¬çš„å®¹å™¨åº”ç”¨ï¼Œæˆ–è€…æˆ‘ä»¬åˆå§‹åŒ– Garfish çš„åœ°æ–¹ã€‚
- **Loader**ï¼šåº”ç”¨åŠ è½½å™¨ï¼Œ Garfish æä¾›äº† HTMLï¼Œ JS ç­‰äº§ç‰©çš„åŠ è½½æ–¹å¼ã€‚
- **Router**ï¼šç›‘å¬è·¯ç”±å˜åŒ–å’ŒåŒ¹é…ã€‚
- **Store**ï¼šå»ºç«‹é€šä¿¡æ¡¥æ¢ï¼Œæä¾›å…±äº«æœºåˆ¶
- **æ²™ç®±éš”ç¦»å­åº”ç”¨**ï¼šJavaScript æ²™ç®±ï¼Œ DOM éš”ç¦»ã€‚
- **ç”Ÿå‘½å‘¨æœŸ**ï¼šGarfish æŠ½è±¡äº†ä¸€å¥—ç”Ÿå‘½å‘¨æœŸï¼Œæ–¹ä¾¿å¼€å‘è€…è¿›è¡Œè°ƒç”¨ã€‚

## æ€è·¯

ä¸Šæ–¹æˆ‘ä»¬äº†è§£åˆ° Garfish çš„æ ¸å¿ƒæ€æƒ³æ˜¯é€šè¿‡ JavaScript æ²™ç®±å’Œ DOM éš”ç¦»æ¥å®ç°å¾®å‰ç«¯ã€‚

äºæ˜¯ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æŒ‰ç…§ç±»ä¼¼çš„æ€è·¯å»å®ç°å¾®å‰ç«¯ï¼Œä¸»è¦ç»„ä»¶åŒ…æ‹¬ï¼š

- **ä¸»åº”ç”¨ï¼ˆå®¹å™¨åº”ç”¨ï¼‰**: æä¾›å®¹å™¨ï¼Œå¹¶åœ¨ç‰¹å®šæ—¶æœºåŠ è½½å­åº”ç”¨å³å¯ã€‚
- **å­åº”ç”¨ï¼š**éœ€è¦å­åº”ç”¨ä½œç‚¹æ”¹é€ ï¼Œæš´éœ²ä¸€ä¸ªçº¦å®šçš„é…ç½®ï¼Œä»è€Œåšæ¸²æŸ“å’ŒåŠ è½½**ã€‚**
- **Loader åº”ç”¨åŠ è½½å™¨ï¼š**åŠ è½½å­åº”ç”¨èµ„æºçš„ç‰¹æœ‰æ¨¡å—**ã€‚**
- **JavaScript æ²™ç®±**ï¼šåšä¸»ã€å­åº”ç”¨çš„éš”ç¦»ã€‚
- **ç”Ÿå‘½å‘¨æœŸï¼š**æ”¯æŒç”Ÿå‘½å‘¨æœŸï¼Œæ–¹ä¾¿åç»­çš„æ’ä»¶ã€é…ç½®ä¿®æ”¹ç­‰èƒ½åŠ›çš„æ‰©å±•**ã€‚**

## å…·ä½“å®ç°

### ä¸»åº”ç”¨

<aside> ğŸ’¡

æä¾›å®¹å™¨ï¼Œå¹¶åœ¨ç‰¹å®šæ—¶æœºåŠ è½½å­åº”ç”¨å³å¯ã€‚

</aside>

è¿™é‡Œï¼Œæˆ‘ä»¬çš„ä¸»åº”ç”¨åªéœ€è¦æä¾›å®¹å™¨ï¼Œä»¥åŠè°ƒç”¨å¾®å‰ç«¯çš„æ‰§è¡Œæ—¶é—´å°± ok äº†ï¼Œå³å¦‚ä¸‹ä»£ç ã€‚

```tsx
import miniMicroFrontend from "./mini-micro-frontend";

const App = () => {
  useEffect(() => {
	  miniMicroFrontend.run({
      domGetter: "#sub_app_container",
    });
    
    const app = await miniMicroFrontend.load({
      name: "app1",
			entry: "<http://localhost:8086/main.js>",
    });
    
    app.mount();
  });
  
  return (
    <div id="sub_app_container"></div>
  );
}
```

### å­åº”ç”¨

<aside> ğŸ’¡

æ”¹æˆçº¦å®šçš„æ ¼å¼ï¼Œä»è€Œä¾¿äºä¸»åº”ç”¨åŠ è½½æ—¶è¿›è¡Œæ¸²æŸ“ã€‚

</aside>

å­åº”ç”¨ï¼Œæˆ‘ä»¬ä¹ŸæŒ‰ç…§ Garfish ç»™çš„è§„èŒƒæ¥è¿›è¡Œå¤„ç†ï¼Œè¿™é‡Œæˆ‘ä»¬å¾—æ³¨æ„ä¸‹ä¸‰ç‚¹

- å†…éƒ¨æ•°æ®ç»“æœå®ç°
- å…¥å£æ–‡ä»¶æš´éœ² `provider` å‡½æ•°
- ä½¿ç”¨ `umd` æ ¼å¼è¿›è¡Œæ‰“åŒ…

**å†…éƒ¨æ•°æ®ç»“æœå®ç°**

```tsx
import Sandbox from "../sandbox";
import {
  MiniMicroFrontendAppConfig,
  MiniMicroFrontendRunOptions,
} from "../typings";

class MiniMicroFrontendApp {
  private appConfig: MiniMicroFrontendAppConfig;
  private config: MiniMicroFrontendRunOptions;
  private sourceCode: string;
  private providerRes: any;
  private sandbox: Sandbox = new Sandbox();

  constructor(
    appConfig: MiniMicroFrontendAppConfig,
    sourceCode: string,
    config: MiniMicroFrontendRunOptions
  ) {
    this.appConfig = appConfig;
    this.sourceCode = sourceCode;
    this.config = config;
  }

  mount() {
    const source = this.sourceCode;

    const { provider } = this.sandbox.run(source);
    this.providerRes = provider();
    this.providerRes?.render({
      dom: document.querySelector(this.config.domGetter!),
    });
  }

  unmount() {
    this.providerRes?.destroy({
      dom: document.querySelector(this.config.domGetter!),
    });
  }
}

export default MiniMicroFrontendApp;
```

**å…¥å£æ–‡ä»¶æš´éœ² Provider å‡½æ•°**

æ ¹æ® Garfish çš„è§„èŒƒï¼Œæˆ‘ä»¬éœ€è¦æš´éœ²ä¸€ä¸ª Provider å‡½æ•°ï¼Œæœ€ç»ˆæ”¾æœ‰ render å’Œ destroy çš„å¯¹è±¡ã€‚

```tsx
import ReactDOM from "react-dom/client";
import App from "./App.tsx";
import "./index.css";

export const provider = () => ({
  render: ({ dom }) => {
    ReactDOM.createRoot(dom).render(<App />);
  },

  destroy: ({ dom }) => {
    ReactDOM.createRoot(dom).unmount();
  },
});
```

**ä½¿ç”¨ umd æ ¼å¼æ‰“åŒ…äº§ç‰©**

æœ¬è´¨ä¸Šæ˜¯å¸Œæœ›èƒ½å¤Ÿæ‹¿åˆ°æš´éœ²å‡ºæ¥çš„ Providerï¼Œæ‰€ä»¥ä½¿ç”¨ umd æ¥å–ã€‚

è¿™é‡Œæ¯”è¾ƒä¾èµ–æ‰“åŒ…å·¥å…·ï¼Œè¿™é‡Œç”¨ rspack ä¸¾ä¸ªä¾‹å­ã€‚

```tsx
import { defineConfig } from "@rspack/cli";
import { rspack } from "@rspack/core";
import * as RefreshPlugin from "@rspack/plugin-react-refresh";

const isDev = process.env.NODE_ENV === "development";

export default defineConfig({
  output: {
    libraryTarget: "umd",
    publicPath: "<http://localhost:8086/>",
  },
});

```

æ»¡è¶³ä¸Šæ–¹ä¸‰ä¸ªç‚¹ä¹‹åï¼Œæˆ‘ä»¬å°±æœ‰åŠ è½½å­åº”ç”¨è¿‡ç¨‹ä¸­ `mount` å’Œ `unmount` èƒ½åŠ›ã€‚

### Loader

<aside> ğŸ’¡

èµ„æºåŠ è½½å™¨ï¼Œåšå¥½èµ„æºä»£ç çš„åŠ è½½ã€‚

</aside>

Loaderï¼Œä½ å¯ä»¥ç†è§£ä¸ºèµ„æºåŠ è½½å™¨ï¼Œä¸»è¦æ˜¯ä¸ºäº†åŠ è½½åº”ç”¨èµ„æºã€‚

```tsx
import { MiniMicroFrontendAppConfig } from "../typings";
import { AppLoaderInfo } from "./typings";
export * from "./typings";

class Loader {
  appMap: WeakMap<MiniMicroFrontendAppConfig, AppLoaderInfo> = new WeakMap();

  async loadApp(app: MiniMicroFrontendAppConfig) {
    if (this.appMap.has(app)) {
      return this.appMap.get(app) as AppLoaderInfo;
    }

    const sourceCode = await (await fetch(app.entry)).text();
    const appLoaderInfo: AppLoaderInfo = {
      sourceCode,
    };
    this.appMap.set(app, appLoaderInfo);

    return appLoaderInfo;
  }
}

export default Loader;

```

ä¸Šæ–¹æ˜¯ Loader çš„ç®€å•å®ç°ï¼Œä¸»è¦æ˜¯ä¸ºäº†è·å–èµ„æºæ–‡ä»¶ï¼Œæ–¹ä¾¿æå– `Provider` å¹¶ä¸”è¿›è¡Œä»£ç æ‰§è¡Œã€‚

### æ²™ç®±å¤„ç†

<aside> ğŸ’¡

æ²™ç®±å¤„ç†å¯ä»¥è¯´æ˜¯å¾®å‰ç«¯çš„é‡ç‚¹ï¼Œå› ä¸ºä¸»ã€å­åº”ç”¨å¯èƒ½å¯¹ window éƒ½æœ‰ä¸åŒçš„å‰¯ä½œç”¨ï¼Œä½äº†è€ƒè™‘å®‰å…¨æ€§ï¼Œæ²™ç®±å¤„ç†æ˜¯å¾ˆé‡è¦çš„ä¸€ä¸ªç‚¹ã€‚

</aside>

**ç›®æ ‡**ï¼šå®ç°ä¸€ä¸ª `JS` æ²™ç®±ï¼Œæ¥å°½é‡å®ç° JS å¯¹å…¨å±€å˜é‡çš„éš”ç¦»ï¼Œå¦‚ window, location, document ç­‰å¯¹è±¡ã€‚

æœ¬æ¬¡æˆ‘ä»¬ä½¿ç”¨ `Proxy` æ¥è¿›è¡Œæ²™ç®±ä»£ç†ï¼Œä¹Ÿå°±æ˜¯ `Garfish` ä¸­çš„ [`vm`](https://www.garfishjs.org/guide/sandbox#vm-%E6%B2%99%E7%AE%B1) æ²™ç®±ã€‚

åŸºæœ¬æ€è·¯å¦‚ä¸‹ã€‚æœ¬è´¨ä¸Šæ˜¯é€šè¿‡å¯¹å…¨å±€å˜é‡çš„ä»£ç†ï¼Œä»è€Œå»å‡å°‘å…¨å±€å˜é‡çš„æ”¹å†™ï¼Œä»è€Œå‡å°‘å˜é‡æ±¡æŸ“ã€‚

```jsx
class Sandbox {
  
  constructor() {
    this.proxyWindow = new Proxy(window, ...);
    this.proxyDocument = new Proxy(document, ...);
    this.proxyLocation = new Proxy(location, ...);
  }

  run(code: string): Record<string, any> | undefined {
    const exports: Record<string, any> = {};

    this.activate();

    let result: Record<string, any> | undefined = undefined;

    try {
      const executionFunction = new Function(
        "window",
        "document",
        "location",
        "exports",
        `
        with (window) {
          ${code};
          return exports;
        }
      `
      );

      result = executionFunction(
        this.proxyWindow,
        this.proxyDocument,
        this.proxyLocation,
        exports
      );
    } catch (err) {
      console.error(err);
    }

    return result;
  }
}
```

å®Œæ•´ä»£ç 

```jsx
class Sandbox {
  private proxyWindow: Window | null = null;
  private proxyDocument: Document | null = null;
  private proxyLocation: Location | null = null;
  private modifiedProps: Map<object, Set<string | symbol>>;
  private active: boolean;
  private originalValues: Map<object, Map<string | symbol, any>>;
  private fakeWindow: Record<string | symbol, any> = {};
  private fakeDocument: Record<string | symbol, any> = {};
  private fakeLocation: Record<string | symbol, any> = {};

  constructor() {
    this.modifiedProps = new Map();
    this.active = false;
    this.originalValues = new Map();
    this.initialProxy();
  }

  private initialProxy() {
    this.proxyWindow = this.createProxy(window) as Window;
    this.proxyDocument = this.createProxy(document) as Document;
    this.proxyLocation = this.createProxy(location) as Location;
  }

  private createProxy(obj: object) {
    if (!this.modifiedProps.has(obj)) {
      this.modifiedProps.set(obj, new Set());
    }
    if (!this.originalValues.has(obj)) {
      this.originalValues.set(obj, new Map());
    }

    return new Proxy(obj, {
      get: (target, p) => {
        if (p === Symbol.unscopables) {
          return target;
        }
        const val = (target as any)[p as string | symbol];
        if (!this.active) {
          return val;
        }

        const modifiedPropsSet = this.modifiedProps.get(target)!;
        if (modifiedPropsSet.has(p)) {
          const fakeObject = this.getFakeObject(target);
          return fakeObject[p as string];
        }

        if (typeof val === "function") {
          return val.bind(target);
        }
      },
      set: (target: object, prop: string | symbol, value: any) => {
        if (!this.active) {
          (target as any)[prop] = value;
          return true;
        }

        const modifiedPropsSet = this.modifiedProps.get(target)!;
        const originalValuesMap = this.originalValues.get(target)!;
        if (!modifiedPropsSet.has(prop)) {
          originalValuesMap.set(prop, (target as any)[prop]);
          modifiedPropsSet.add(prop);
        }
        const fakeObject = this.getFakeObject(target);
        fakeObject[prop as string] = value;
        return true;
      },
      has: (target: object, prop: string | symbol) => {
        return prop in target || this.modifiedProps.get(target)!.has(prop);
      },
    });
  }

  activate() {
    this.active = true;
  }

  deactivate() {
    this.active = false;
  }

  run(code: string): Record<string, any> | undefined {
    const exports: Record<string, any> = {};

    this.activate();

    let result: Record<string, any> | undefined = undefined;

    try {
      const executionFunction = new Function(
        "window",
        "document",
        "location",
        "exports",
        `
        with (window) {
          ${code};
          return exports;
        }
      `
      );

      result = executionFunction(
        this.proxyWindow,
        this.proxyDocument,
        this.proxyLocation,
        exports
      );
    } catch (err) {
      console.error(err);
    }

    return result;
  }

  reset() {
    this.deactivate();
    for (const [target, modifiedPropsSet] of this.modifiedProps.entries()) {
      const originalValuesMap = this.originalValues.get(target)!;
      const fakeObject = this.getFakeObject(target);
      for (const prop of modifiedPropsSet) {
        if (originalValuesMap.has(prop)) {
          fakeObject[prop as string] = originalValuesMap.get(prop);
        } else {
          delete fakeObject[prop as string];
        }
      }
      modifiedPropsSet.clear();
      originalValuesMap.clear();
    }
  }

  private getFakeObject(target: object): { [key: string]: any } {
    if (target === window) return this.fakeWindow;
    if (target === document) return this.fakeDocument;
    if (target === location) return this.fakeLocation;
    throw new Error("Unknown target object");
  }
}

export default Sandbox;
```

`MiniMicroFrontendApp`

```jsx
import Sandbox from "../sandbox";
import {
  MiniMicroFrontendAppConfig,
  MiniMicroFrontendRunOptions,
} from "../typings";

class MiniMicroFrontendApp {
  mount() {
    const source = this.sourceCode;

    const { provider } = this.sandbox.run(source);
    this.providerRes = provider();
    this.providerRes?.render({
      dom: document.querySelector(this.config.domGetter!),
    });
  }
}

export default MiniMicroFrontendApp;

```

æœ¬è´¨ä¸Šæ˜¯ `mount` çš„æ—¶å€™å»é€šè¿‡æ‰§è¡Œæ²™ç®±ä»£ç ã€‚

ç”±äºç¯‡å¹…å…³ç³»ï¼Œ `sandbox` å¹¶æ²¡æœ‰è®²çš„å¾ˆæ·±å…¥ï¼Œè€Œä¸”ä¹Ÿåªæ˜¯ç®€å•å®ç°äº†ä¸€éï¼ŒåŒæ—¶ï¼Œç”±äºæ˜¯åŸºäº `proxy` å®ç°çš„ï¼Œæ‰€ä»¥è¿˜ä¼šé¢ä¸´å…¼å®¹æ€§é—®é¢˜ï¼Œæ‰€ä»¥è¿˜æœ‰ `å¿«ç…§æ²™ç®±` çš„æ¦‚å¿µã€‚

å¦‚æœè¯»è€…å¯¹è¿™ä¸€å—æ„Ÿå…´è¶£ï¼Œåç»­ç¬”è€…ä¼šä¸“é—¨å†™ç¯‡æ–‡ç« å…·ä½“è®²è®²ã€‚

### ç”Ÿå‘½å‘¨æœŸ

<aside> ğŸ’¡

æ”¯æŒç”Ÿå‘½å‘¨æœŸï¼Œæ–¹ä¾¿åç»­çš„æ’ä»¶ã€é…ç½®ä¿®æ”¹ç­‰èƒ½åŠ›çš„æ‰©å±•

</aside>

æ’ä»¶ã€ç”Ÿå‘½å‘¨æœŸæ„Ÿè§‰åº”è¯¥æ˜¯ä¸€ä¸ªæ¡†æ¶å¿…ä¸å¯å°‘çš„éƒ¨åˆ†çš„ã€‚åŒæ ·çš„ï¼Œ `Garfish` è®¾è®¡çš„æ¯”è¾ƒå·§å¦™ï¼Œä¹Ÿæä¾›äº†æ’ä»¶èƒ½åŠ›ï¼Œå…·ä½“è€Œè¨€æ²™ç®±ï¼Œè·¯ç”±èƒ½åŠ›è²Œä¼¼éƒ½æ˜¯ä»¥æ’ä»¶çš„å½¢å¼è¿›è¡Œæ”¯æŒçš„ã€‚

æˆ‘ä»¬è¿™é‡Œä¹Ÿç¨å¾®å®ç°ä¸‹å§ï¼Œæœ¬è´¨è¿˜æ˜¯å‚è€ƒ `webpack` å’Œ `tapable` çš„é‚£ä¸€å¥—ã€‚

```jsx
import { SyncHook } from "./syncHook";
import { LifeCycle, LifeCycleKey, MiniMicroFrontendPlugin } from "./typings";

class PluginSystem {
  public lifeCycle: LifeCycle = {
    bootstrap: new SyncHook("bootstrap"),
    beforeLoad: new SyncHook("beforeLoad"),
    afterLoad: new SyncHook("afterLoad"),
    beforeMount: new SyncHook("beforeMount"),
    afterMount: new SyncHook("afterMount"),
    beforeUnmount: new SyncHook("beforeUnmount"),
    afterUnmount: new SyncHook("afterUnmount"),
  };

  private plugins: MiniMicroFrontendPlugin[] = [];

  usePlugin(plugin: MiniMicroFrontendPlugin) {
    if (this.plugins.includes(plugin)) {
      throw new Error(`plugin ${plugin.name} has been used`);
    }
    this.plugins.push(plugin);
    for (let key in this.lifeCycle) {
      const callback = plugin[key as LifeCycleKey];
      if (callback) {
        this.lifeCycle[key as LifeCycleKey].on(callback);
      }
    }
  }
}

export default PluginSystem;

```

å¹¶ä¸”æŒ‚åœ¨ MiniMicroFrontend ä¸Š

```jsx
class MiniMicroFrontend {
  hooks: PluginSystem = new PluginSystem();

  run(userOptions?: MiniMicroFrontendRunOptions & LifeCyclePluginOptions) {
    this.options = userOptions || {};
    this.hooks.usePlugin(getLifeCyclePlugin(userOptions || {}));
    this.status = "started";
    this.hooks.lifeCycle.bootstrap.emit(this.options);
  }

  async load(app: MiniMicroFrontendAppConfig) {
    this.hooks.lifeCycle.beforeLoad.emit(app);
    const { sourceCode } = await this.loader.loadApp(app);
    const appInstance = new MiniMicroFrontendApp(app, sourceCode, this.options);
    this.hooks.lifeCycle.afterLoad.emit(app);
    return appInstance;
  }
}

const miniMicroFrontend = new MiniMicroFrontend();

export default miniMicroFrontend;
```

åç»­æˆ‘ä»¬å°±å¯ä»¥è¿™ä¹ˆè°ƒç”¨

```jsx
miniMicroFrontend.hooks.lifeCycle.bootstrap.on((...args) => {
	console.log(
	  'miniMicroFrontend', ...args
	);
})
```

### æ•´ä½“æ¡†æ¶

æˆ‘ä»¬å…ˆæ•´ä½“å°†æµç¨‹ä¸²èµ·æ¥

```tsx
import MiniMicroFrontendApp from "./app";
import { LifeCyclePluginOptions, getLifeCyclePlugin } from "./built-in";
import PluginSystem from "./hooks/pluginSystem";
import Loader from "./loader";
import {
  MiniMicroFrontendAppConfig,
  MiniMicroFrontendRunOptions,
} from "./typings";

class MiniMicroFrontend {
  status: "started" | "stopped" = "stopped";
  loader: Loader = new Loader();
  options: MiniMicroFrontendRunOptions = {};
  activeApp: MiniMicroFrontendApp | null = null;
  hooks: PluginSystem = new PluginSystem();

  run(userOptions?: MiniMicroFrontendRunOptions & LifeCyclePluginOptions) {
    this.options = userOptions || {};
    this.hooks.usePlugin(getLifeCyclePlugin(userOptions || {}));
    this.status = "started";
    this.hooks.lifeCycle.bootstrap.emit(this.options);
  }

  async load(app: MiniMicroFrontendAppConfig) {
    this.hooks.lifeCycle.beforeLoad.emit(app);
    const { sourceCode } = await this.loader.loadApp(app);
    const appInstance = new MiniMicroFrontendApp(app, sourceCode, this.options);
    this.hooks.lifeCycle.afterLoad.emit(app);
    return appInstance;
  }
}

const miniMicroFrontend = new MiniMicroFrontend();

export default miniMicroFrontend;

```

ä¸‹é¢ï¼Œå°±æ˜¯æ•´ä½“æµç¨‹çš„ä¸²èµ·æ¥äº†ï¼Œä»¥åŠè¯•ä¸€ä¸‹ Demo

**ä»£ç **

`useInitMiniMicro`

```jsx
import React, { useEffect } from "react";
import miniMicroFrontend from "./mini-micro-frontend";
import { MiniMicroFrontendAppConfig } from "./mini-micro-frontend/typings";
import MiniMicroFrontendApp from "./mini-micro-frontend/app";

const sleep = (ms: number) => new Promise((resolve) => setTimeout(resolve, ms));

const app1: MiniMicroFrontendAppConfig = {
  name: "app1",
  entry: "<http://localhost:8086/main.js>",
};

const app2: MiniMicroFrontendAppConfig = {
  name: "app2",
  entry: "<http://localhost:8084/main.js>",
};

export const useInitMiniMicro = () => {
  const app1Ref = React.useRef<MiniMicroFrontendApp>();
  const app2Ref = React.useRef<MiniMicroFrontendApp>();

  useEffect(() => {
    miniMicroFrontend.run({
      domGetter: "#sub_app_container",
      bootstrap(options) {
        console.log("bootstrap", options);
      },
      beforeLoad(app) {
        console.log("beforeLoad", app);
      },
      afterLoad(app) {
        console.log("afterLoad", app);
      },
    });
  }, []);

  const loadApp = async (app: MiniMicroFrontendAppConfig) => {
    return await miniMicroFrontend.load(app);
  };

  const loadApp1 = async () => {
    if (app2Ref.current) {
      app2Ref.current.unmount();
    }
    await sleep(50);
    const app = await loadApp(app1);
    app1Ref.current = app;
    app.mount();
  };

  const loadApp2 = async () => {
    if (app1Ref.current) {
      app1Ref.current.unmount();
    }
    await sleep(50);
    const app = await loadApp(app2);
    app2Ref.current = app;
    app.mount();
  };

  return {
    loadApp1,
    loadApp2,
  };
};

export default useInitMiniMicro;

```

`App.tsx`

```jsx
import "./App.css";
import useInitMiniMicro from "./use-init-mini-micro";
import { useEffect } from "react";

function App() {
  const { loadApp1, loadApp2 } = useInitMiniMicro();

  useEffect(() => {
    loadApp1();
  }, []);

  return (
    <div className="App">
      <h1>Mini Micro FrontEnd</h1>
      <div style={{ display: "flex", gap: 16 }}>
        <button onClick={() => loadApp1()}>react app</button>
        <button onClick={() => loadApp2()}>vue app</button>
      </div>
      <div id="sub_app_container" style={{ height: 500, width: 800 }}></div>
    </div>
  );
}

export default App;

```

æ•´ä½“æ•ˆæœ
![20240901160706_rec_.gif](https://raw.githubusercontent.com/hua-bang/assert-store/master/20240901160706_rec_.gif)

## æ€»ç»“

è¿™ç¯‡æ–‡ç« ç®€å•çš„è®²äº†å¾®å‰ç«¯æ¡†æ¶ Garfish çš„è®¾è®¡çš„æ€è·¯ï¼Œä»¥åŠå‡ ä¸ªé‡è¦çš„ç»„ä»¶å’Œæ¦‚å¿µï¼Œå¦‚ä¸»åº”ç”¨ã€Loaderã€æ²™ç®±ï¼Œç”Ÿå‘½å‘¨æœŸç­‰ã€‚åŒæ—¶ï¼Œæœ€ç»ˆæˆ‘ä»¬å¦‚ä½•åŸºäº Garfish è®¾è®¡è‡ªå·±çš„å¾®å‰ç«¯æ¡†æ¶ã€‚å…·ä½“å®ç°ä¸Šå’Œ Garfish çš„å·®åˆ«å¥½æœ‰ç‚¹å¤§ï¼Œä½†æ˜¯æ€è·¯æ–¹å‘æ˜¯å·®ä¸å¤šçš„ã€‚

å¸Œæœ›é€šè¿‡è¿™ä¸ªæ–‡ç« ï¼Œèƒ½å¤Ÿè®©ä½ å¯¹å¾®å‰ç«¯æœ‰æ›´å¤šçš„ç†è§£å§ã€‚åŒæ—¶ï¼Œç”±äºç¯‡å¹…é—®é¢˜ï¼Œè¿™é‡Œå¾ˆå¤šç‚¹æ²¡æœ‰åŠæ³•è®²ç»†è®²ï¼Œ**å¦‚ Garfish è®¾è®¡çš„è¯¦ç»†åˆ†æã€æ²™ç®±éš”ç¦»çš„å¤„ç†**ï¼Œ**ä»¥åŠ `Router` å’Œ `Store` çš„å¤„ç†**ï¼Œè¿™äº›æ›´é€‚åˆå•ç‚¹å•ç‚¹å»è®²å§ã€‚

å¦‚æœè¯»è€…æœ‰éœ€è¦ï¼Œç¬”è€…åç»­å¯èƒ½ä¹Ÿä¼šå»ä¸“é—¨å»å†™å…³äºæŸä¸ªå•ç‚¹çš„æ–‡ç« ã€‚